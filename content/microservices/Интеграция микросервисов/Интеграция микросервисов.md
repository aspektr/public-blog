## Введение

Строя модели предметных областей мы всегда определяем их границы – ограниченный контекст (bounded context). При этом разные ограниченные контексты могут содержать одни и те же бизнес сущности, но моделировать мы их можем по-разному для решения своих задач.

Модели в разных ограниченных контекстах могут развиваться и реализовываться независимо. Но сами ограниченные контексты в масштабах предприятия не могут являться независимыми. Система не может быть построена полностью из независимых компонентов, а предприятие не может управляться на полностью независимых ограниченных контекстах.

Хотя ограниченные контексты могут развиваться независимо, предприятие предпочитает управлять ими из единой точки. Возможно несколько путей развития:


* Изначально в компании была внедрена методика DDD, были определены ограниченные контексты, микросервисы проектировались «толстыми» и над каждым работает независимая команда. Такое решение становится возможным, когда проект создается с нуля или на микросервисы делится один монолит. 

* В случае же когда предприятие изначально использовало несколько монолитов (например, несколько CRM), что говорит о том, что изначально существовало несколько ограниченных контекстов, то попытка одновременно реформировать организационные подходы и IT ландшафт несет дополнительные риски, которые должны быть подвергнуты тщательной оценке перед стартом проекта. 


В случае реализации «толстых» микросервисов предприятие получает единый микросервисный ландшафт:

![[Pasted image 20250205095625.png]]


Однако, при сохранении старой доменной модели и старого подхода к «нарезке» команд легко прийти к следующему варианту:

![[Pasted image 20250205095723.png]]

Этот вариант уже представляет из себя вариацию паттерна «общее ядро» и будет подробно рассмотрен ниже.

Во следующем варианте операционная работа осуществляется независимо в каждом ограниченном контексте, но каждый из них имеет контракты на поставку данных по определенным шаблонам в платформы управления данными предприятия. 

Например, каждый ограниченный контекст может вести свой тип заказов со своим набором атрибутов, но при этом каждый из них поставляет эти данные в платформу данных, где в контракте, определяемым архитектором данных на предприятии указан определенный ключ, однообразный для всех сервисов/микросервисов и монолитов в компании. 

Такой ключ позволяет управлять сущностями централизованно, обеспечивать преимущества при интеграции систем и переход с одних систем на другие. Далее данный подход подробно рассматриваться не будет.

![[Pasted image 20250205095819.png]]

 В третьем варианте, когда независимые команды обнаружили общие сущности, может встать вопрос об объединении/интеграции ограниченных контекстов (или микросервисов на физическом уровне).  Так как эти изменения затрагивают более одной стороны их необходимо определить и скоординировать. Далее будут рассмотрены паттерны интеграции и их проблемы. Мы разделим их на три группы, каждая из которых представляет тип командного сотрудничества: сотрудничество, клиент-поставщик и другие.


## Паттерны

### Сотрудничество

В модели сотрудничество интеграция между ограниченными контекстами координируется ad-hoc образом. Одна команда может уведомить другую об изменении API, а вторая команда будет адаптироваться под эти изменения.

![[Pasted image 20250205100048.png]]


Координация интеграции здесь двухсторонняя. Ни одна из команд не диктует язык, который используется для определения контрактов. 

Команды умеют урегулировать разногласия и выбирать наиболее подходящее решение. Стороны сотрудничают при решении любых проблем интеграции. Ни одна из команд не заинтересована в блокировке другой.

Паттерн лишен смысла если микросервисы являются донорами монолита.

### Общее ядро

Несмотря на то, что ограниченные контексты являются границами модели, могут быть случаи, когда одна и та же модель поддомена или ее часть будет реализована в нескольких ограниченных контекстах. 

Крайне важно подчеркнуть, что общая модель разрабатывается и согласуется в соответствии с потребностями всех ограниченных контекстов, которые ее используют.

![[Pasted image 20250205100310.png]]

Каждый ограниченный контекст может изменять модель ценообразования, и эти изменения влияют на другие ограниченные контексты, использующие модель.

В случае с донором в виде монолита эта модель выглядит следующим образом, где монолит выступает общим ядром.


![[Pasted image 20250205100326.png]]

### Общая область действия

Перекрывающаяся модель связывает жизненные циклы зависимых ограниченных контекстов. Изменение, внесенное в общую модель, немедленно влияет на все ограниченные контексты. Следовательно, чтобы минимизировать каскадные эффекты изменений, перекрывающаяся модель должна быть ограничена, раскрывая только ту часть модели, которая должна быть реализована обоими ограниченными контекстами    

#### Реализация

Общее ядро реализуется таким образом, что любые изменения в его исходном коде немедленно отражаются во всех ограниченных контекстах, использующих его.

Если предприятие использует подход с моно репозиторием, это могут быть те же исходные файлы, на которые ссылаются несколько ограниченных контекстов. Если использование общего репозитория невозможно, общее ядро может быть извлечено в выделенный проект

![[Pasted image 20250205100408.png]]
#### Когда использовать общее ядро

Общим критерием применимости шаблона общего ядра является стоимость дублирования по сравнению со стоимостью координации. Поскольку шаблон вводит сильную зависимость между участвующими ограниченными контекстами, его следует применять только тогда, когда стоимость дублирования выше стоимости координации.

В некотором смысле шаблон общего ядра противоречит принципам ограниченных контекстов. Если участвующие ограниченные контексты не реализованы одной и той же командой, введение общего ядра противоречит принципу, согласно которому одна команда должна владеть ограниченным контекстом. Перекрывающая модель – общее ядро, по сути, разрабатывается несколькими командами.

Вот почему использование общего ядра должно тщательно рассматриваться. Это прагматическое исключение. Реализация тесно связанной функциональности, без надлежащей координации приведет к проблемам интеграции, рассинхронизации и спорам кто лучше проектирует. Минимизация области действия общего ядра контролирует область каскадных изменений.

Другой распространенный вариант использования шаблона общего ядра, хотя и временный, — это постепенная модернизация устаревшей системы. В таком сценарии общий донор становится прагматичным промежуточным решением для постепенного разложения системы на ограниченные контексты.

Общее ядро может хорошо подойти для интеграции ограниченных контекстов, принадлежащих и реализуемых одной командой.

## Клиент-поставщик

Вторая группа шаблонов клиент-поставщик: один из ограниченных контекстов поставщик – предоставляет услугу своим клиентам. Поставщик услуг находится выше по течение (upstream), а клиент или потребитель ниже (downstream)

![[Pasted image 20250205100704.png]]

В большинстве случаем мы получаем дисбаланс сил: либо вышестоящая, либо нижестоящая команда может диктовать контракт на интеграцию.

Рассмотри три модели, решающие такие различия сил: конформисткая, антикоррупционная и модель услуг с открытым хостом.

### Конформист

В некоторых случаях баланс сил благоприятствует команде вышестоящего уровня, у которой нет реальной мотивации поддерживать потребности своих клиентов. 

Вместо этого она просто предоставляет контракт на интеграцию, определенный в соответствии с ее собственной моделью – принимаете его или откажитесь. 

Такой дисбаланс сил может быть вызван интеграцией с поставщиками услуг, которые являются внешними по отношению к организации, или просто организационной политикой.

### Антикоррупционная модель

Как и в конформистской модели, баланс сил в этих отношениях по-прежнему смещен в сторону вышестоящей команды. 

Однако в этом случае нижестоящий ограниченный контекст не желает зависимостей. Вместо этого он может перевести модель вышестоящего ограниченного контекста в модель, адаптированную к его собственным потребностям, с помощью антикоррупционного слоя.

![[Pasted image 20250205100759.png]]


Шаблон антикоррупционного слоя рассматривает сценарии, в которых нежелательно или не стоит усилий соответствовать модели поставщика, например, следующие:

* Когда нисходящий ограниченный контекст содержит основной поддомен
* Модель основного поддомена требует дополнительного внимания, и следование модели поставщика может затруднить моделирование проблемной области.
* Когда восходящая модель неэффективна или неудобна для нужд потребителя
* Если ограниченный контекст соответствует беспорядку, он сам рискует стать беспорядком. Это часто случается при интеграции с устаревшими системами.
* Когда контракт поставщика часто меняется
* Потребитель хочет защитить свою модель от частых изменений. С антикоррупционным слоем изменения в модели поставщика влияют только на механизм маппинга.

С точки зрения моделирования маппинг модели поставщика изолирует нисходящего потребителя от чуждых концепций, которые не имеют отношения к его ограниченному контексту. Следовательно, он упрощает модель потребителя.

### Открытый хост

Этот шаблон рассматривает случаи, в которых баланс перекошен в сторону потребителей. Поставщик заинтересован в защите своих потребителей и предоставлении наилучшего возможного сервиса.

Чтобы защитить потребителей от изменений в своей модели реализации, поставщик вышестоящего уровня отделяет модель реализации от публичного интерфейса. Такое отделение позволяет поставщику развивать свою реализацию и публичные модели с разной скоростью

![[Pasted image 20250205100911.png]]

Открытый интерфейс поставщика не предназначен для соответствия его модели. Вместо этого он предназначен для предоставления удобного для потребителей протокола, выраженного на языке, ориентированном на интеграцию.

В некотором смысле, шаблон службы открытого хоста является обратным шаблону антикоррупционного слоя: вместо потребителя поставщик реализует перевод своей внутренней модели.

Разделение моделей реализации и интеграции ограниченного контекста дает ограниченному контексту верхнего потока свободу развивать свою реализацию, не влияя на контексты нижнего потока. Конечно, это возможно только в том случае, если измененную модель реализации можно перевести на опубликованный контракт, который уже используют потребители.

Более того, разделение модели интеграции позволяет ограниченному контексту верхнего потока одновременно предоставлять несколько версий опубликованного контракта, позволяя потребителю постепенно переходить на новую версию.

## Раздельные пути

Последний вариант сотрудничества — вообще не сотрудничать. Такая модель может возникнуть по разным причинам, в случаях, когда команды не хотят или не могут сотрудничать. Мы рассмотрим некоторые из них здесь.

### Проблемы коммуникации

Обычной причиной избегания сотрудничества являются трудности в общении, вызванные размером организации или внутренней политикой. Когда командам трудно сотрудничать и договариваться, может быть более экономически выгодно пойти разными путями и дублировать функциональность в нескольких ограниченных контекстах.

### Универсальные поддомены

Характер продублированного поддомена также может быть причиной того, что команды идут разными путями. Когда рассматриваемый поддомен является универсальным, и, если универсальное решение легко интегрировать, может быть более экономически выгодно интегрировать его локально в каждый ограниченный контекст. Дублирование функциональности будет менее затратным, чем сотрудничество.

### Различия в моделях

Различия в моделях ограниченных контекстов также могут быть причиной для сотрудничества по отдельным путям. Модели могут быть настолько разными, что конформистские отношения невозможны, а реализация антикоррупционного слоя будет более затратной, чем дублирование функциональности. В таком случае для команд снова будет более экономически выгодно пойти разными путями.

### Примечание

Шаблона раздельных путей следует избегать при интеграции основных поддоменов и когда стоит цель распилить монолит. Дублирование реализации таких поддоменов будет противоречить стратегии компании по их внедрению наиболее эффективным и оптимизированным способом.

## Итоговые варианты

Исходя из вышеизложенного мы можем рассмотреть следующие варианты:

##### Монолит – общее ядро:

![[Pasted image 20250205101045.png]]

##### Микросервис – общее ядро:

![[Pasted image 20250205101059.png]]

##### Клиент-Поставщик:

![[Pasted image 20250205101113.png]]
